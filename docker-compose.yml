# Core Infrastructure Services
# Nginx Proxy Manager: Reverse proxy with Let's Encrypt SSL
# MinIO: Shared S3-compatible object storage (used by Supabase and custom services)


networks:
  dokploy-network:
    external: true

services:
  # np:
  #   image: 'jc21/nginx-proxy-manager:latest'
  #   restart: unless-stopped
  #   networks: [proxy_net]
  #   ports:
  #     - '80:80'
  #     - '443:443'
  #     - '81:81'
  #   volumes:
  #     - ./np:/data
  #     - ./letsencrypt:/etc/letsencrypt
  #
  # ============================================================================
  # MONITORING STACK
  # To enable: Use deploy.sh --with-monitoring or docker compose --profile monitoring up -d
  # ============================================================================

  grafana:
    image: grafana/grafana:11.1.0
    container_name: memozen-grafana
    environment:
      GF_SERVER_HTTP_PORT: 4123
      GF_SECURITY_ADMIN_USER: ${GRAFANA_ADMIN_USER:-admin}
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASSWORD:-123123qaqaw}
      GF_USERS_ALLOW_SIGN_UP: "false"
      GF_INSTALL_PLUGINS: ""
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro
    networks: [dokploy-network, default]
    ports:
      - "3010:4123"
    restart: unless-stopped
    depends_on:
      - prometheus

  prometheus:
    image: prom/prometheus:v2.55.0
    container_name: memozen-prometheus
    command:
      - "--config.file=/etc/prometheus/prometheus.yml"
      - "--storage.tsdb.retention.time=15d"
      - "--web.enable-lifecycle"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus_data:/prometheus
    networks: [dokploy-network, default]
    ports:
      - "9090:9090"
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:v0.27.0
    container_name: memozen-alertmanager
    command:
      - "--config.file=/etc/alertmanager/alertmanager.yml"
      - "--storage.path=/alertmanager"
    volumes:
      - ./alertmanager:/etc/alertmanager:ro
      - alertmanager_data:/alertmanager
    networks: [dokploy-network, default]
    ports:
      - "9093:9093"
    restart: unless-stopped

  node-exporter:
    image: prom/node-exporter:v1.8.2
    container_name: memozen-node-exporter
    networks: [dokploy-network, default]
    restart: unless-stopped
    command:
      - "--path.rootfs=/host"
    volumes:
      - /:/host:ro,rslave
    pid: host

  cadvisor:
    image: gcr.io/cadvisor/cadvisor:v0.49.1
    container_name: memozen-cadvisor
    ports:
      - "127.0.0.1:8089:8080"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:ro
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
      - /dev/disk/:/dev/disk:ro
    networks: [dokploy-network, default]
    restart: unless-stopped
    privileged: true
    devices:
      - /dev/kmsg

  postgres-exporter:
    image: prometheuscommunity/postgres-exporter:v0.15.0
    container_name: memozen-postgres-exporter
    environment:
      DATA_SOURCE_NAME: "postgresql://${POSTGRES_USER:-postgres}:${POSTGRES_PASSWORD}@${POSTGRES_HOST:-db}:${POSTGRES_PORT:-5432}/${POSTGRES_DB:-postgres}?sslmode=disable"
    networks: [dokploy-network, default]
    restart: unless-stopped
    depends_on:
      - prometheus

  minio:
    image: minio/minio
    networks:
      - default
      - dokploy-network
    ports:
      - '9000:9000'
      - '9001:9001'
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    # command: server --console-address ":9001" /data
    entrypoint: >
      /bin/sh -c "
      /usr/bin/docker-entrypoint.sh server --console-address ':9001' /data &
      pid=$$!;
      echo 'Waiting for MinIO to start...';
      for i in $$(seq 1 30); do
        if curl -s http://127.0.0.1:9000/minio/health/live >/dev/null 2>&1; then
          echo 'MinIO is up, creating bucket...';
          mc alias set local http://127.0.0.1:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD};
          mc mb -p local/memozen || true;
          break;
        fi;
        sleep 1;
      done;
      wait $$pid"
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://minio:9000/minio/health/live" ]
      interval: 2s
      timeout: 10s
      retries: 5
    volumes:
      - minio-data:/data

    labels:
      - "traefik.enable=true"
      # HTTP → HTTPS redirect (опціонально, але рекомендую)
      - "traefik.http.routers.minio-http.rule=Host(`${MINIO_DOMAIN}`)"
      - "traefik.http.routers.minio-http.entrypoints=web"
      - "traefik.http.routers.minio-http.middlewares=redirect-to-https"

    # HTTPS router
      - "traefik.http.routers.minio.rule=Host(`${MINIO_DOMAIN}`)"
      - "traefik.http.routers.minio.entrypoints=websecure"
      - "traefik.http.routers.minio.tls=true"
      - "traefik.http.routers.minio.tls.certresolver=letsencrypt"

    # Service
      - "traefik.http.services.minio.loadbalancer.server.port=9001"


  #
  # whisper-service:
  #   build:
  #     context: ../whisper-service
  #     dockerfile: Dockerfile
  #   image: memozen-whisper-service:latest
  #   container_name: memozen-whisper-service
  #   restart: unless-stopped
  #   networks:
  #     - default
  #     - proxy_net
  #   ports:
  #     - "8095:8095"  # Whisper API endpoint
  #   environment:
  #     - WHISPER_MODEL=${WHISPER_MODEL:-base}
  #     - MODEL_CACHE_DIR=/models
  #     - DEVICE=${WHISPER_DEVICE:-cpu}
  #     - COMPUTE_TYPE=${WHISPER_COMPUTE_TYPE:-int8}
  #     - BEAM_SIZE=${BEAM_SIZE:-5}
  #     - VAD_FILTER=${VAD_FILTER:-true}
  #     - VAD_MIN_SILENCE_DURATION_MS=${VAD_MIN_SILENCE_DURATION_MS:-500}
  #     - HOST=0.0.0.0
  #     - PORT=8095
  #     - LOG_LEVEL=${LOG_LEVEL:-info}
  #     - MAX_FILE_SIZE_MB=${MAX_FILE_SIZE_MB:-25}
  #     - TEMP_DIR=/tmp/whisper
  #     - NUM_WORKERS=${WHISPER_NUM_WORKERS:-1}
  #   volumes:
  #     - whisper-models:/models
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   healthcheck:
  #     test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8095/health').raise_for_status()"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s
  #
  #
  worker-transcription:
    # build:
    #   context: ../worker-transcription
    #   dockerfile: Dockerfile
    image: git.peinlab.pp.ua/memozen/worker-transcription:latest
    pull_policy: always
    container_name: memozen-transcription-worker
    restart: unless-stopped
    networks:
      - default
      - dokploy-network
    ports:
      - "8090:8090"  # Prometheus metrics endpoint
    environment:
      - SUPABASE_URL=${API_EXTERNAL_URL}
      - SUPABASE_KEY=${SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - WHISPER_API_URL=${WHISPER_API_URL:-http://whisper-service:8095}
      - WHISPER_MODEL=${WHISPER_MODEL:-whisper-1}
      - ANALYZE_MODEL=${ANALYZE_MODEL:-gpt-4o-mini}
      - METRICS_PORT=8090
      - REVENUECAT_API_KEY=${REVENUECAT_API_KEY}
      - REVENUECAT_WEBHOOK_SECRET=${REVENUECAT_WEBHOOK_SECRET}

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  worker-analysis:
    # build:
    #   context: ../worker-analysis
    #   dockerfile: Dockerfile
    image: git.peinlab.pp.ua/memozen/worker-analysis:latest
    pull_policy: always
    container_name: memozen-analysis-worker
    restart: unless-stopped
    networks:
      - default
      - dokploy-network
    ports:
      - "8091:8091"  # Prometheus metrics endpoint
    environment:
      - SUPABASE_URL=${API_EXTERNAL_URL}
      - SUPABASE_KEY=${SERVICE_ROLE_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANALYZE_MODEL=${ANALYZE_MODEL:-gpt-4o-mini}
      - METRICS_PORT=8091
      - REVENUECAT_API_KEY=${REVENUECAT_API_KEY}
      - REVENUECAT_WEBHOOK_SECRET=${REVENUECAT_WEBHOOK_SECRET}
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    depends_on:
      - worker-transcription

  worker-embedding:
     # build:
     #   context: ../worker-embedding
     #   dockerfile: Dockerfile
     image: git.peinlab.pp.ua/memozen/worker-embedding:latest
     pull_policy: always
     container_name: memozen-embedding-worker
     restart: unless-stopped
     networks:
       - default
       - dokploy-network
     ports:
       - "8092:8092"  # Prometheus metrics endpoint
     environment:
       - SUPABASE_URL=${API_EXTERNAL_URL}
       - SUPABASE_KEY=${SERVICE_ROLE_KEY}
       - OPENAI_API_KEY=${OPENAI_API_KEY}
       - EMBEDDING_MODEL=${EMBEDDING_MODEL:-text-embedding-3-small}
       - METRICS_PORT=8092
       - REVENUECAT_API_KEY=${REVENUECAT_API_KEY}
       - REVENUECAT_WEBHOOK_SECRET=${REVENUECAT_WEBHOOK_SECRET}
     logging:
       driver: "json-file"
       options:
         max-size: "10m"
         max-file: "3"
     depends_on:
       - worker-analysis

  worker-renewal:
    # build:
    #   context: ../worker-renewal
    #   dockerfile: Dockerfile
    image: git.peinlab.pp.ua/memozen/worker-renewal:latest
    pull_policy: always
    container_name: memozen-renewal-worker
    restart: unless-stopped
    networks:
      - default
      - dokploy-network
    ports:
      - "8093:8093"  # Webhook endpoint
      - "8094:8094"  # Prometheus metrics endpoint
    environment:
      - SUPABASE_URL=${API_EXTERNAL_URL}
      - SUPABASE_KEY=${SERVICE_ROLE_KEY}
      - REVENUECAT_API_KEY=${REVENUECAT_API_KEY}
      - REVENUECAT_WEBHOOK_SECRET=${REVENUECAT_WEBHOOK_SECRET}
      - WEBHOOK_PORT=8093
      - METRICS_PORT=8094
      - RENEWAL_CHECK_INTERVAL_MS=${RENEWAL_CHECK_INTERVAL_MS:-3600000}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - FREE_USER_RESET_DAYS=${FREE_USER_RESET_DAYS:-30}
    labels:
      - "traefik.enable=true"
      # HTTP → HTTPS redirect (опціонально, але рекомендую)
      - "traefik.http.routers.worker-renewal-http.rule=Host(`${PAYWALL_ENDPOINT}`)"
      - "traefik.http.routers.worker-renewal-http.entrypoints=web"
      - "traefik.http.routers.worker-renewal-http.middlewares=redirect-to-https"

    # HTTPS router
      - "traefik.http.routers.worker-renewal.rule=Host(`${PAYWALL_ENDPOINT}`)"
      - "traefik.http.routers.worker-renewal.entrypoints=websecure"
      - "traefik.http.routers.worker-renewal.tls=true"
      - "traefik.http.routers.worker-renewal.tls.certresolver=letsencrypt"

    # Service
      - "traefik.http.services.worker-renewal.loadbalancer.server.port=8093"

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  loki:
    image: grafana/loki:3.0.0
    networks:
     - dokploy-network
     - default

    container_name: loki
    command: -config.file=/etc/loki/local-config.yml
    volumes:
      - ./loki/loki-config.yml:/etc/loki/local-config.yml:ro
      - loki-data:/loki
    ports:
      - "3100:3100"
    restart: unless-stopped

  promtail:
    image: grafana/promtail:3.0.0
    container_name: promtail
    networks:
      - dokploy-network
      #- proxy_net
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /etc/machine-id:/etc/machine-id:ro
    command: -config.file=/etc/promtail/config.yml
    restart: unless-stopped

volumes:
  loki-data:
  grafana_data:
  prometheus_data:
  alertmanager_data:
  whisper-models:
  minio-data:
